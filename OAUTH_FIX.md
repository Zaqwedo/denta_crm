# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï OAUTH –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò

**–î–∞—Ç–∞**: 2026-01-30  
**–ü—Ä–æ–±–ª–µ–º–∞**: Google –∏ Yandex OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. Middleware (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- ‚úÖ –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `/login` –≤ middleware, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–ª–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- ‚úÖ –¢–µ–ø–µ—Ä—å OAuth callbacks —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–§–∞–π–ª**: `middleware.ts`  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –£–¥–∞–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ 37-45 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ `/login`)

---

## ‚ö†Ô∏è –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ –í–†–£–ß–ù–£–Æ

### Google OAuth ‚Äî Error 400: redirect_uri_mismatch

**–ü—Ä–æ–±–ª–µ–º–∞**: Google Cloud Console –Ω–µ –∑–Ω–∞–µ—Ç –æ –≤–∞—à–µ–º redirect URI

**–†–µ—à–µ–Ω–∏–µ** (5 –º–∏–Ω—É—Ç):

1. **–û—Ç–∫—Ä–æ–π—Ç–µ Google Cloud Console**:
   - https://console.cloud.google.com/

2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç**:
   - –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç Denta CRM

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ OAuth 2.0**:
   - APIs & Services ‚Üí Credentials
   - –ù–∞–π–¥–∏—Ç–µ –≤–∞—à OAuth 2.0 Client ID
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

4. **–î–æ–±–∞–≤—å—Ç–µ Authorized redirect URIs**:
   ```
   http://localhost:3000/api/auth/google/callback
   ```
   
   –î–ª—è production —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ:
   ```
   https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/auth/google/callback
   ```

5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

6. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   # Ctrl+C —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
   npm run dev
   ```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google OAuth:

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/login
2. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google"
3. –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç Google
4. –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/patients`
5. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤

### Yandex OAuth:

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/login
2. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"
3. –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –Ø–Ω–¥–µ–∫—Å
4. –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/patients`
5. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú

### –ï—Å–ª–∏ Google OAuth –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
```bash
# –í .env.local –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
GOOGLE_CLIENT_ID=–≤–∞—à_client_id
GOOGLE_CLIENT_SECRET=–≤–∞—à_client_secret
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞**:
- F12 ‚Üí Console
- –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º "Google OAuth"

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞**:
- –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω `npm run dev`
- –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å "Google OAuth Callback Debug"

---

### –ï—Å–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login –≤—Å–µ –µ—â–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

**–û—á–∏—Å—Ç–∏—Ç–µ cookies**:
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12):
document.cookie.split(";").forEach(c => {
  document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
});
location.reload();
```

**–û—á–∏—Å—Ç–∏—Ç–µ localStorage**:
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12):
localStorage.clear();
location.reload();
```

---

## üìù –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫:

1. **Middleware –∫–æ–Ω—Ñ–ª–∏–∫—Ç**:
   - Middleware –ø—Ä–æ–≤–µ—Ä—è–ª `/login` –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–ª –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ù–æ matcher –ù–ï –∏—Å–∫–ª—é—á–∞–ª `/login` –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ race condition —Å OAuth callbacks

2. **Google redirect_uri**:
   - Google —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è redirect URI
   - URI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Google Cloud Console
   - –î–∞–∂–µ `http://localhost:3000` vs `http://localhost:3000/` ‚Äî —Ä–∞–∑–Ω—ã–µ URI!

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google"**:
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Google OAuth
   - Google –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
   - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/api/auth/google/callback?code=...`

2. **Callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è**:
   - `/api/auth/google/callback` –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ access_token
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookies (`denta_auth`, `denta_user_email`)
   - –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/patients?google_auth=success&user=...`

3. **GoogleAuthHandler –Ω–∞ `/patients`**:
   - –ß–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
   - –í—ã–∑—ã–≤–∞–µ—Ç `login()` –≤ AuthContext
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
   - –û—á–∏—â–∞–µ—Ç URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

4. **ProtectedRoute –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é**:
   - –ï—Å–ª–∏ `isAuthenticated` –∏–ª–∏ `isOAuthCallback` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
   - –ò–Ω–∞—á–µ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login`

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢

- [x] Middleware –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- [ ] Google OAuth redirect URI –¥–æ–±–∞–≤–ª–µ–Ω –≤ Google Cloud Console
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å
- [ ] –û—á–∏—â–µ–Ω—ã cookies –∏ localStorage (–µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã)

---

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ OAuth –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å!** üéâ
