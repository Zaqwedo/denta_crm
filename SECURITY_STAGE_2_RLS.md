# โ ะญัะฐะฟ 2: Row Level Security (RLS) โ ะะะะะะจะะ

## ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ

### 1. ะะฑะฝะพะฒะปะตะฝะฐ ะฐััะธัะตะบัััะฐ ะบะปะธะตะฝัะพะฒ Supabase
- โ ะะพะฑะฐะฒะปะตะฝะฐ ััะฝะบัะธั `getSupabaseUser(userEmail)` ั base64-ะบะพะดะธัะพะฒะฐะฝะธะตะผ email
- โ ะะฑะฝะพะฒะปะตะฝะฐ ััะฝะบัะธั `getSupabaseAdmin()` ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั Service Role Key
- โ Email ะบะพะดะธััะตััั ะฒ base64 ะดะปั ะฟะพะดะดะตัะถะบะธ ะบะธัะธะปะปะธัั ะฒ HTTP ะทะฐะณะพะปะพะฒะบะฐั

### 2. ะะตัะฐะบัะพัะธะฝะณ ััะฝะบัะธะน ัะฐะฑะพัั ั ะะ
- โ ะัะต ััะฝะบัะธะธ ะฒ `lib/supabase-db.ts` ะพะฑะฝะพะฒะปะตะฝั ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฟัะฐะฒะธะปัะฝะพะณะพ ะบะปะธะตะฝัะฐ
- โ ะะดะผะธะฝ ะธัะฟะพะปัะทัะตั `getSupabaseAdmin()` (ะพะฑัะพะดะธั RLS)
- โ ะะฑััะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะธัะฟะพะปัะทััั `getSupabaseUser(email)` (ะฟะพะดัะธะฝััััั RLS)

### 3. ะะฐัััะพะตะฝ Service Role Key
- โ `SUPABASE_SERVICE_ROLE_KEY` ะดะพะฑะฐะฒะปะตะฝ ะฒ `.env.local`
- โ ะะปัั ะธัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะฝะฐ ัะตัะฒะตัะต (ะฑะตะทะพะฟะฐัะฝะพ)

### 4. ะัะฟะพะปะฝะตะฝ SQL-ัะบัะธะฟั ะฒ Supabase
- โ ะกะพะทะดะฐะฝั 3 ััะฝะบัะธะธ PostgreSQL:
  - `get_user_email()` โ ะธะทะฒะปะตะบะฐะตั ะธ ะดะตะบะพะดะธััะตั email ะธะท ะทะฐะณะพะปะพะฒะบะฐ
  - `user_can_access_doctor(doctor_name)` โ ะฟัะพะฒะตััะตั ะดะพัััะฟ ะบ ะฒัะฐัั
  - `user_can_access_nurse(nurse_name)` โ ะฟัะพะฒะตััะตั ะดะพัััะฟ ะบ ะผะตะดัะตัััะต
- โ ะกะพะทะดะฐะฝั RLS-ะฟะพะปะธัะธะบะธ ะดะปั ัะฐะฑะปะธั:
  - `patients` โ 4 ะฟะพะปะธัะธะบะธ (SELECT, INSERT, UPDATE, DELETE)
  - `patient_changes` โ 2 ะฟะพะปะธัะธะบะธ (SELECT, INSERT)
  - `deleted_patients` โ 2 ะฟะพะปะธัะธะบะธ (SELECT, INSERT)

## ะะฐะบ ัะฐะฑะพัะฐะตั RLS

### ะััะธัะตะบัััะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Next.js Application                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. ะะพะปัะทะพะฒะฐัะตะปั ะฒัะพะดะธั (email + password)                   โ
โ  2. Email ัะพััะฐะฝัะตััั ะฒ ะบัะบะธ: denta_user_email               โ
โ  3. ะัะพะฒะตัะบะฐ ัะพะปะธ: checkAdminAuth()                          โ
โ     โโ ะะดะผะธะฝ โ getSupabaseAdmin() (Service Role)             โ
โ     โโ User  โ getSupabaseUser(email) (Anon Key + header)    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                  HTTP Request ั ะทะฐะณะพะปะพะฒะบะพะผ:
                  x-denta-user-email-b64: dmJybXZAaWNsb3VkLmNvbQ==
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Supabase Database                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  RLS Policy ะฒัะฟะพะปะฝัะตััั ะดะปั ะะะะะะะ ะทะฐะฟัะพัะฐ:                 โ
โ                                                              โ
โ  1. get_user_email() ะดะตะบะพะดะธััะตั base64 โ vbrmv@icloud.com    โ
โ  2. user_can_access_doctor("ะะฐัะฝะฐััะพะฒ ะ.ะ.") โ TRUE/FALSE    โ
โ  3. ะัะปะธ TRUE โ ะทะฐะฟัะพั ะฒัะฟะพะปะฝัะตััั                           โ
โ     ะัะปะธ FALSE โ ัััะพะบะฐ ะฝะต ะฒะพะทะฒัะฐัะฐะตััั                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะัะธะผะตั ัะฐะฑะพัั

**ะกัะตะฝะฐัะธะน**: ะะพะปัะทะพะฒะฐัะตะปั `vbrmv@icloud.com` ะทะฐะฟัะฐัะธะฒะฐะตั ัะฟะธัะพะบ ะฟะฐัะธะตะฝัะพะฒ

1. **ะัะธะปะพะถะตะฝะธะต**:
   ```typescript
   const email = 'vbrmv@icloud.com'
   const client = getSupabaseUser(email) // ัะพะทะดะฐะตั ะบะปะธะตะฝั ั ะทะฐะณะพะปะพะฒะบะพะผ
   const { data } = await client.from('patients').select('*')
   ```

2. **HTTP ะทะฐะฟัะพั**:
   ```
   GET /rest/v1/patients
   Headers:
     x-denta-user-email-b64: dmJybXZAaWNsb3VkLmNvbQ==
   ```

3. **Supabase RLS**:
   ```sql
   -- ะะปั ะบะฐะถะดะพะน ัััะพะบะธ ะฒ ัะฐะฑะปะธัะต patients:
   SELECT * FROM patients
   WHERE user_can_access_doctor("ะะพะบัะพั") = TRUE
   
   -- user_can_access_doctor("ะะฐัะฝะฐััะพะฒ ะ.ะ."):
   --   1. ะะตะบะพะดะธััะตั email: vbrmv@icloud.com
   --   2. ะะฐัะพะดะธั ะฒ whitelist_emails: id = 11
   --   3. ะัะพะฒะตััะตั whitelist_email_doctors:
   --      WHERE whitelist_email_id = 11 AND doctor_name = 'ะะฐัะฝะฐััะพะฒ ะ.ะ.'
   --   4. ะะพะทะฒัะฐัะฐะตั TRUE ะธะปะธ FALSE
   ```

4. **ะะตะทัะปััะฐั**:
   - ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั **ัะพะปัะบะพ** ะฟะฐัะธะตะฝัะพะฒ ะฒัะฐัะตะน, ะบ ะบะพัะพััะผ ั ะฝะตะณะพ ะตััั ะดะพัััะฟ
   - ะะฐะถะต ะตัะปะธ ะบัะพ-ัะพ ะฟะพะปััะธั API ะบะปัั, ะพะฝ ะฝะต ัะผะพะถะตั ะพะฑะพะนัะธ RLS ะฑะตะท ะฟัะฐะฒะธะปัะฝะพะณะพ email

## ะขะตััะธัะพะฒะฐะฝะธะต RLS

### ะขะตัั 1: ะะดะผะธะฝ ะฒะธะดะธั ะฒัะตั ะฟะฐัะธะตะฝัะพะฒ
1. ะะพะนะดะธัะต ะบะฐะบ ะฐะดะผะธะฝ (ะฟะฐัะพะปั `2423`)
2. ะัะบัะพะนัะต `/patients/card-index`
3. **ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั**: ะะธะดะฝั ะะกะ ะฟะฐัะธะตะฝัั (402 ะทะฐะฟะธัะธ)

### ะขะตัั 2: ะะฑััะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ัะพะปัะบะพ ัะฒะพะธั ะฒัะฐัะตะน
1. ะะพะนะดะธัะต ะบะฐะบ `vbrmv@icloud.com`
2. ะัะบัะพะนัะต `/patients/card-index`
3. **ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั**: ะะธะดะฝั ัะพะปัะบะพ ะฟะฐัะธะตะฝัั ะฒัะฐัะตะน ะธะท whitelist

### ะขะตัั 3: ะะพะฟััะบะฐ ะพะฑัะพะดะฐ RLS ัะตัะตะท API
1. ะัะบัะพะนัะต DevTools โ Network
2. ะะฐะนะดะธัะต ะทะฐะฟัะพั ะบ Supabase API
3. ะกะบะพะฟะธััะนัะต ะทะฐะฟัะพั ะฒ Postman/curl
4. ะะพะฟัะพะฑัะนัะต ะธะทะผะตะฝะธัั ะทะฐะณะพะปะพะฒะพะบ `x-denta-user-email-b64`
5. **ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั**: ะะฐะฝะฝัะต ัะธะปัััััััั ะฟะพ ะฝะพะฒะพะผั email

### ะขะตัั 4: ะััะผะพะน ะดะพัััะฟ ะบ Supabase (ะฑะตะท ะฟัะธะปะพะถะตะฝะธั)
1. ะัะฟะพะปัะทัะนัะต Supabase REST API ะฝะฐะฟััะผัั ั `anon` ะบะปััะพะผ
2. ะะตะท ะทะฐะณะพะปะพะฒะบะฐ `x-denta-user-email-b64` โ **ะฝะตั ะดะฐะฝะฝัั**
3. ะก ะฝะตะฟัะฐะฒะธะปัะฝัะผ email โ **ะฝะตั ะดะฐะฝะฝัั**
4. ะก ะฟัะฐะฒะธะปัะฝัะผ email โ **ัะพะปัะบะพ ัะฐะทัะตัะตะฝะฝัะต ะดะฐะฝะฝัะต**

## ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั

### โ๏ธ ะะตะทะพะฟะฐัะฝะพััั

**Service Role Key**:
- โ ะัะฟะพะปัะทัะตััั ะขะะะฌะะ ะฝะฐ ัะตัะฒะตัะต
- โ ะะฑัะพะดะธั ะฒัะต RLS-ะฟะพะปะธัะธะบะธ
- โ ะะะะะะะ ะฝะต ะพัะฟัะฐะฒะปัะนัะต ะฒ ะบะปะธะตะฝััะบะธะน ะบะพะด
- โ ะะะะะะะ ะฝะต ะบะพะผะผะธัััะต ะฒ Git

**Anon Key**:
- โ ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฒ ะบะปะธะตะฝััะบะพะผ ะบะพะดะต
- โ ะะพะดัะธะฝัะตััั RLS-ะฟะพะปะธัะธะบะฐะผ
- โ ะะตะทะพะฟะฐัะฝะพ ะฟัะฑะปะธะบะพะฒะฐัั (ะตัะปะธ RLS ะฝะฐัััะพะตะฝ ะฟัะฐะฒะธะปัะฝะพ)

### ๐ ะัะปะฐะดะบะฐ

ะัะปะธ ะดะฐะฝะฝัะต ะฝะต ะพัะพะฑัะฐะถะฐัััั:

1. **ะัะพะฒะตัััะต ะปะพะณะธ Supabase**:
   - Dashboard โ Logs โ Postgres Logs
   - ะัะธัะต ะพัะธะฑะบะธ RLS

2. **ะัะพะฒะตัััะต ะทะฐะณะพะปะพะฒะบะธ**:
   ```javascript
   // ะ DevTools โ Network โ Headers
   x-denta-user-email-b64: dmJybXZAaWNsb3VkLmNvbQ==
   ```

3. **ะัะพะฒะตัััะต whitelist**:
   ```sql
   -- ะ SQL Editor
   SELECT * FROM whitelist_emails WHERE email = 'vbrmv@icloud.com';
   SELECT * FROM whitelist_email_doctors WHERE whitelist_email_id = 11;
   ```

4. **ะขะตััะธััะนัะต ััะฝะบัะธะธ ะฝะฐะฟััะผัั**:
   ```sql
   -- ะ SQL Editor
   SELECT get_user_email(); -- ะดะพะปะถะตะฝ ะฒะตัะฝััั NULL (ะฝะตั ะทะฐะณะพะปะพะฒะบะฐ)
   SELECT user_can_access_doctor('ะะฐัะฝะฐััะพะฒ ะ.ะ.'); -- ะดะพะปะถะตะฝ ะฒะตัะฝััั FALSE
   ```

### โ ะัะตะธะผััะตััะฒะฐ RLS

1. **ะะฐัะธัะฐ ะฝะฐ ััะพะฒะฝะต ะะ**: ะะฐะถะต ะตัะปะธ ะบัะพ-ัะพ ะฟะพะปััะธั API ะบะปัั, ะดะฐะฝะฝัะต ะทะฐัะธัะตะฝั
2. **ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะปะพะณะธะบะฐ**: ะัะฐะฒะธะปะฐ ะดะพัััะฟะฐ ะฒ ะพะดะฝะพะผ ะผะตััะต (PostgreSQL)
3. **ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะปัััะฐัะธั**: ะะต ะฝัะถะฝะพ ะดะพะฑะฐะฒะปััั WHERE ะฒ ะบะฐะถะดัะน ะทะฐะฟัะพั
4. **ะัะดะธั**: ะัะต ะทะฐะฟัะพัั ะปะพะณะธัััััั Supabase

### ๐ ะกะปะตะดัััะธะต ัะฐะณะธ

**ะญัะฐะฟ 3: ะฃัะธะปะตะฝะธะต ัะตัะธัะพะฒะฐะฝะธั ะฟะฐัะพะปะตะน**
- ะฃะฒะตะปะธัะธัั ะบะพะปะธัะตััะฒะพ ะธัะตัะฐัะธะน PBKDF2
- ะะพะฑะฐะฒะธัั ัะพะปั (salt) ะดะปั ะบะฐะถะดะพะณะพ ะฟะฐัะพะปั
- ะะฑะฝะพะฒะธัั ััะฝะบัะธะธ ัะตัะธัะพะฒะฐะฝะธั

**Production Deployment**:
1. ะะพะฑะฐะฒะธัั `SUPABASE_SERVICE_ROLE_KEY` ะฒ Vercel Environment Variables
2. ะัะพะฒะตัะธัั, ััะพ RLS ะฒะบะปััะตะฝ ะดะปั ะฒัะตั ัะฐะฑะปะธั
3. ะัะพัะตััะธัะพะฒะฐัั ั ัะตะฐะปัะฝัะผะธ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ

## ะกัะฐััั

- โ Service Role Key ะฝะฐัััะพะตะฝ
- โ ะคัะฝะบัะธะธ PostgreSQL ัะพะทะดะฐะฝั
- โ RLS-ะฟะพะปะธัะธะบะธ ะฟัะธะผะตะฝะตะฝั
- โ ะะพะด ะฟัะธะปะพะถะตะฝะธั ะพะฑะฝะพะฒะปะตะฝ
- โณ ะขัะตะฑัะตััั ัะตััะธัะพะฒะฐะฝะธะต
- โณ ะญัะฐะฟ 3: ะฃัะธะปะตะฝะธะต ัะตัะธัะพะฒะฐะฝะธั ะฟะฐัะพะปะตะน
